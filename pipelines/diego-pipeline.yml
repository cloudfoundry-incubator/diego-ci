groups:
- name: diego
  jobs:
  - bump-garden
  - simulate-auctions
  - check-for-windows-drift
  - check-proto-files
  - check-diego-release
  - units-common
  - units-mysql
  - units-postgres
  - units-windows
  - validate-garden-version
  - inigo-mysql
  - inigo-postgres
  - inigo-windows
  - candidate
  - electron-cannon-deploy-cf-deployment
  - electron-cannon-test-evacuation
  - electron-cannon-smoke-tests
  - electron-cannon-vizzini
  - electron-cannon-cf-acceptance-tests
  - electron-cannon-run-wats
  - export-diego-release
  - upgrade-routability-tests-from-v1.0.0
  - upgrade-routability-tests-from-v1.25.2
  - upgrade-acceptance-tests-from-v1.0.0
  - upgrade-acceptance-tests-from-v1.25.2
  - time-rotor-gcp-benchmark-bbs-tests
  - warp-drive-deploy-cf-deployment
  - warp-drive-test-evacuation
  - warp-drive-smoke-tests
  - warp-drive-cf-acceptance-tests
  - warp-drive-run-wats
  - warp-drive-vizzini
  - deliver
  - shipit
  - github-release
  - merge-master-into-develop
  - validate-envoy-version
  - oslo-scan-status
- name: dusts
  jobs:
  - upgrade-routability-tests-from-v1.0.0
  - upgrade-routability-tests-from-v1.25.2
  - upgrade-acceptance-tests-from-v1.0.0
  - upgrade-acceptance-tests-from-v1.25.2
- name: electron-cannon
  jobs:
  - bbl-up-electron-cannon
  - electron-cannon-bosh-cleanup
  - electron-cannon-cf-acceptance-tests
  - electron-cannon-deploy-cf-deployment
  - electron-cannon-test-evacuation
  - electron-cannon-run-wats
  - electron-cannon-smoke-tests
  - electron-cannon-vizzini
  - electron-cannon-vizzini-periodic
- name: warp-drive
  jobs:
  - bbl-up-warp-drive
  - warp-drive-deploy-cf-deployment
  - warp-drive-test-evacuation
  - warp-drive-smoke-tests
  - warp-drive-cf-acceptance-tests
  - warp-drive-vizzini-periodic
  - warp-drive-bosh-cleanup
  - warp-drive-vizzini
  - warp-drive-run-wats
- name: version
  jobs:
  - major-bump
  - minor-bump
  - patch-bump
- name: diego-periodic
  jobs:
  - electron-cannon-bosh-cleanup
  - electron-cannon-vizzini-periodic
  - warp-drive-vizzini-periodic
  - warp-drive-bosh-cleanup
  - check-expired-bosh-certs
  - check-expired-test-fixture-certs
  - update-golang-packages
  - update-envoy-blob
- name: time-rotor
  jobs:
  - bbl-up-time-rotor-gcp
  - time-rotor-gcp-benchmark-bbs-tests
  - time-rotor-gcp-bosh-cleanup
- name: manual
  jobs:
  - warp-drive-push-canary
  - electron-cannon-push-canary
  - release-candidate-lock

jobs:
- name: bbl-up-warp-drive
  serial_groups:
  - warp-drive-cf-deployment
  - warp-drive-cf-acceptance-tests
  public: true
  plan:
  - in_parallel:
    - get: nightly
      trigger: true
    - get: bosh-bootloader
    - get: cf-deployment-concourse-tasks
    - get: deployments-diego
    - get: cf-deployment
  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: envs/warp-drive/keys/gcp-service-account-key.json
      BBL_GCP_REGION: us-central1
      BBL_LB_CERT: ../../certs/elb-cfrouter.crt
      BBL_LB_KEY: ../../certs/elb-cfrouter.key
      BBL_ENV_NAME: warp-drive
      LB_DOMAIN: warp-drive.cf-app.com
      BBL_STATE_DIR: envs/warp-drive/deployments/bbl
    input_mapping:
      bbl-state: deployments-diego
      bbl-config: deployments-diego
    ensure:
      put: deployments-diego
      params:
        repository: updated-bbl-state
        rebase: true

- name: bbl-up-electron-cannon
  serial_groups:
  - electron-cannon-bosh
  - electron-cannon-cf-deployment
  - electron-cannon-cf-acceptance-tests
  - electron-cannon-smoke-tests
  - electron-cannon-push-canary
  public: true
  plan:
  - in_parallel:
    - get: nightly
      trigger: true
    - get: bosh-bootloader
    - get: cf-deployment-concourse-tasks
    - get: deployments-diego
    - get: cf-deployment
  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: envs/electron-cannon/keys/gcp-service-account-key.json
      BBL_GCP_REGION: us-central1
      BBL_LB_CERT: ../../certs/gcp-cfrouter.crt
      BBL_LB_KEY: ../../certs/gcp-cfrouter.key
      BBL_ENV_NAME: electron-cannon
      LB_DOMAIN: electron-cannon.cf-app.com
      BBL_STATE_DIR: envs/electron-cannon/deployments/bbl
    input_mapping:
      bbl-state: deployments-diego
      bbl-config: deployments-diego
    ensure:
      put: deployments-diego
      params:
        repository: updated-bbl-state
        rebase: true

- name: bbl-up-time-rotor-gcp
  serial_groups:
  - time-rotor-gcp-bosh
  - time-rotor-gcp-benchmark
  public: true
  plan:
  - in_parallel:
    - get: nightly
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: deployments-diego
    - get: cf-deployment
  - task: setup-infrastructure
    file: cf-deployment-concourse-tasks/bbl-up/task.yml
    params:
      BBL_IAAS: gcp
      BBL_GCP_SERVICE_ACCOUNT_KEY: envs/time-rotor-gcp/keys/gcp-service-account-key.json
      BBL_GCP_REGION: us-central1
      BBL_LB_CERT: ../../certs/elb-cfrouter.pem
      BBL_LB_KEY: ../../certs/elb-cfrouter.key
      BBL_ENV_NAME: time-rotor
      LB_DOMAIN: time-rotor-gcp.cf-app.com
      BBL_STATE_DIR: envs/time-rotor-gcp/deployments/bbl
    input_mapping:
      bbl-state: deployments-diego
      bbl-config: deployments-diego
    ensure:
      put: deployments-diego
      params:
        repository: updated-bbl-state
        rebase: true

- name: check-expired-bosh-certs
  plan:
  - in_parallel:
    - get: every-30-days
      trigger: true
    - get: deployments-diego
    - get: diego-ci
  - task: check
    file: diego-ci/tasks/check_expired_certs.build.yml

- name: check-expired-test-fixture-certs
  plan:
  - in_parallel:
    - get: every-30-days
      trigger: true
    - get: diego-release
    - get: diego-ci
  - task: check
    file: diego-ci/tasks/check_expired_certs_in_diego_release.build.yml
    params:
      CERT_DIRECTORY: ./diego-release/src/code.cloudfoundry.org

- name: simulate-auctions
  public: true
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/run_auction_simulation.build.yml
    params:

- name: check-for-windows-drift
  public: true
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/check_for_windows_drift.yml

- name: check-proto-files
  public: true
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/check_proto_files.build.yml

- name: check-diego-release
  public: true
  plan:
  - get: diego-release
    trigger: true
  - get: diego-ci
  - task: build
    file: diego-ci/tasks/check_diego_release.build.yml

- name: units-common
  public: true
  serial_groups: [units]
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/run_unit.build.yml
    privileged: true
    params:
      SCRIPT: run-unit-tests-no-backing-store
      ECR_TEST_AWS_ACCESS_KEY_ID: ((aws-ecr-access-key-id))
      ECR_TEST_AWS_SECRET_ACCESS_KEY: ((aws-ecr-secret-access-key))
      ECR_TEST_REPO_URI: ((aws-ecr-repo-uri))

- name: update-envoy-blob
  serial: true
  plan:
  - in_parallel:
    - get: diego-ci
    - get: diego-release
    - get: envoyproxy-image
      trigger: true
  - task: create-envoy-blob
    file: diego-ci/tasks/create_envoy_blob.build.yml
  - task: update-envoy-blob
    file: diego-ci/tasks/update_envoy_blob.build.yml
    params:
      access_key_id: ((aws-diego-final-release-access-key-id))
      secret_access_key: ((aws-diego-final-release-secret-access-key))
  - put: diego-release-envoy-bump
    params:
      repository: updated-diego-release
      force: true
  - task: create-pr
    file: diego-ci/tasks/create_diego_pr.build.yml
    params:
      GITHUB_TOKEN: ((cf-diego-user-github-access-token))
      LABEL: "dependencies"
      BRANCH: "bump-envoy"
    input_mapping:
      diego-release: updated-diego-release

- name: update-golang-packages
  serial: true
  plan:
  - in_parallel:
    - get: diego-ci
    - get: diego-release
    - get: golang-release
      trigger: true
  - task: update-golang-packages
    file: diego-ci/tasks/update_golang_packages.build.yml
    params:
      access_key_id: ((aws-diego-final-release-access-key-id))
      secret_access_key: ((aws-diego-final-release-secret-access-key))
  - put: diego-release-golang-bump
    params:
      repository: updated-diego-release
      force: true
  - task: create-pr
    file: diego-ci/tasks/create_diego_pr.build.yml
    params:
      GITHUB_TOKEN: ((cf-diego-user-github-access-token))
      LABEL: "dependencies"
      BRANCH: "bump-golang"
    input_mapping:
      diego-release: updated-diego-release

- name: units-mysql
  public: true
  serial_groups: [units]
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/run_unit.build.yml
    privileged: true
    params:
      SCRIPT: run-unit-tests-with-backing-store
      SQL_FLAVOR: mysql

- name: units-postgres
  public: true
  serial_groups: [units]
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/run_unit.build.yml
    privileged: true
    params:
      SCRIPT: run-unit-tests-with-backing-store
      SQL_FLAVOR: postgres

- name: units-windows
  public: true
  serial_groups: [units-windows]
  plan:
  - get: diego-release
    trigger: true
  - task: build
    file: diego-release/scripts/ci/run_unit_windows.build.yml

- name: inigo-mysql
  serial_groups: [inigo-mysql]
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
    - get: garden-runc-release-tarball
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: routing-release
      params: { submodules: none }
    - get: routing-release-tarball
    - get: diego-ci
  - task: garden-runc-release
    file: diego-ci/tasks/checkout_garden.build.yml
  - task: routing-release
    file: diego-ci/tasks/checkout_routing.build.yml
    input_mapping:
      routing-release-master: routing-release
  - task: build
    privileged: true
    file: diego-release/scripts/ci/run_inigo_grootfs.build.yml
    params:
      DEFAULT_EVENTUALLY_TIMEOUT: 5m
      SQL_FLAVOR: mysql
      INIGO_PRIVATE_DOCKER_IMAGE_URI: ((inigo-private-docker-image-uri))
      INIGO_PRIVATE_DOCKER_IMAGE_REF: ((inigo-private-docker-image-ref))
      INIGO_PRIVATE_DOCKER_IMAGE_ROOTFS_PATH: ((inigo-private-docker-image-rootfs-path))
      INIGO_PRIVATE_DOCKER_IMAGE_USERNAME: ((inigo-private-docker-image-username))
      INIGO_PRIVATE_DOCKER_IMAGE_PASSWORD: ((inigo-private-docker-image-password))
      INIGO_ECR_AWS_ACCESS_KEY_ID: ((inigo-ecr-aws-access-key-id))
      INIGO_ECR_AWS_SECRET_ACCESS_KEY: ((inigo-ecr-aws-secret-access-key))
      INIGO_ECR_IMAGE_REF: ((inigo-ecr-image-ref))
      INIGO_ECR_IMAGE_ROOTFS_PATH: ((inigo-ecr-image-rootfs-path))
      INIGO_ECR_IMAGE_URI: ((inigo-ecr-image-uri))

- name: inigo-postgres
  serial_groups: [inigo-postgres]
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
    - get: garden-runc-release-tarball
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: routing-release
      params: { submodules: none }
    - get: routing-release-tarball
    - get: diego-ci
  - task: garden-runc-release
    file: diego-ci/tasks/checkout_garden.build.yml
  - task: routing-release
    file: diego-ci/tasks/checkout_routing.build.yml
    input_mapping:
      routing-release-master: routing-release
  - task: build
    privileged: true
    file: diego-release/scripts/ci/run_inigo_grootfs.build.yml
    params:
      DEFAULT_EVENTUALLY_TIMEOUT: 5m
      SQL_FLAVOR: postgres
      INIGO_PRIVATE_DOCKER_IMAGE_URI: ((inigo-private-docker-image-uri))
      INIGO_PRIVATE_DOCKER_IMAGE_REF: ((inigo-private-docker-image-ref))
      INIGO_PRIVATE_DOCKER_IMAGE_ROOTFS_PATH: ((inigo-private-docker-image-rootfs-path))
      INIGO_PRIVATE_DOCKER_IMAGE_USERNAME: ((inigo-private-docker-image-username))
      INIGO_PRIVATE_DOCKER_IMAGE_PASSWORD: ((inigo-private-docker-image-password))
      INIGO_ECR_AWS_ACCESS_KEY_ID: ((inigo-ecr-aws-access-key-id))
      INIGO_ECR_AWS_SECRET_ACCESS_KEY: ((inigo-ecr-aws-secret-access-key))
      INIGO_ECR_IMAGE_REF: ((inigo-ecr-image-ref))
      INIGO_ECR_IMAGE_ROOTFS_PATH: ((inigo-ecr-image-rootfs-path))
      INIGO_ECR_IMAGE_URI: ((inigo-ecr-image-uri))

- name: inigo-windows
  serial: true
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
    - get: garden-runc-release-tarball
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: routing-release
      params: { submodules: none }
    - get: routing-release-tarball
    - get: winc-release
    - get: envoy-nginx-release
      trigger: true
    - get: diego-ci
  - task: garden-runc-release
    file: diego-ci/tasks/checkout_garden.build.yml
  - task: routing-release
    file: diego-ci/tasks/checkout_routing.build.yml
    input_mapping:
      routing-release-master: routing-release
  - task: build
    privileged: true
    file: diego-release/scripts/ci/run_inigo_windows.build.yml
    params:
      DEFAULT_EVENTUALLY_TIMEOUT: 5m
      SQL_FLAVOR: mysql
      GARDEN_ROOTFS: "docker:///cloudfoundry/windows2016fs:2019.0.54"
      SKIP_PACKAGES: "volman,executor,certauthority"
      GINKGO_PARALLEL: "false"
      FLAKE_ATTEMPTS: 2

- name: upgrade-acceptance-tests-from-v1.0.0
  serial_groups: [dusts-v1.0.0]
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
    - get: diego-release-v1.0.0
      trigger: true
    - get: garden-runc-release-tarball
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: routing-release
      params: { submodules: none }
    - get: routing-release-tarball
    - get: diego-ci
    - get: deployments-diego
  - task: garden-runc-release
    file: diego-ci/tasks/checkout_garden.build.yml
  - task: routing-release
    file: diego-ci/tasks/checkout_routing.build.yml
    input_mapping:
      routing-release-master: routing-release
  - task: build
    privileged: true
    file: diego-release/scripts/ci/run_upgrade_acceptance.build.yml
    input_mapping:
      diego-release-v0: diego-release-v1.0.0
      grace-vars: deployments-diego
    params:
      DIEGO_VERSION_V0: v1.0.0
    ensure:
      put: diego-dusts-logs
      params:
        file: logs/dusts*.log
        acl: public-read

- name: upgrade-acceptance-tests-from-v1.25.2
  serial_groups: [dusts-v1.25.2]
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
    - get: diego-release-v1.25.2
      trigger: true
    - get: garden-runc-release-tarball
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: routing-release
      params: { submodules: none }
    - get: routing-release-tarball
    - get: diego-ci
    - get: deployments-diego
  - task: garden-runc-release
    file: diego-ci/tasks/checkout_garden.build.yml
  - task: routing-release
    file: diego-ci/tasks/checkout_routing.build.yml
    input_mapping:
      routing-release-master: routing-release
  - task: build
    privileged: true
    file: diego-release/scripts/ci/run_upgrade_acceptance.build.yml
    input_mapping:
      diego-release-v0: diego-release-v1.25.2
      grace-vars: deployments-diego
    params:
      DIEGO_VERSION_V0: v1.25.2
    ensure:
      put: diego-dusts-logs
      params:
        file: logs/dusts*.log
        acl: public-read

- name: upgrade-routability-tests-from-v1.0.0
  serial_groups: [dusts-v1.0.0]
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
    - get: diego-release-v1.0.0
      trigger: true
    - get: garden-runc-release-tarball
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: routing-release
      params: { submodules: none }
    - get: routing-release-tarball
    - get: diego-ci
    - get: deployments-diego
  - task: garden-runc-release
    file: diego-ci/tasks/checkout_garden.build.yml
  - task: routing-release
    file: diego-ci/tasks/checkout_routing.build.yml
    input_mapping:
      routing-release-master: routing-release
  - task: build
    privileged: true
    file: diego-release/scripts/ci/run_upgrade_routability.build.yml
    input_mapping:
      diego-release-v0: diego-release-v1.0.0
      grace-vars: deployments-diego
    params:
      DIEGO_VERSION_V0: v1.0.0
    ensure:
      put: diego-dusts-logs
      params:
        file: logs/dusts*.log
        acl: public-read

- name: upgrade-routability-tests-from-v1.25.2
  serial_groups: [dusts-v1.25.2]
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
    - get: diego-release-v1.25.2
      trigger: true
    - get: garden-runc-release-tarball
      trigger: true
    - get: garden-runc-release-master
      params: {submodules: none}
    - get: routing-release
      params: { submodules: none }
    - get: routing-release-tarball
    - get: diego-ci
    - get: deployments-diego
  - task: garden-runc-release
    file: diego-ci/tasks/checkout_garden.build.yml
  - task: routing-release
    file: diego-ci/tasks/checkout_routing.build.yml
    input_mapping:
      routing-release-master: routing-release
  - task: build
    privileged: true
    file: diego-release/scripts/ci/run_upgrade_routability.build.yml
    input_mapping:
      diego-release-v0: diego-release-v1.25.2
      grace-vars: deployments-diego
    params:
      DIEGO_VERSION_V0: v1.25.2
    ensure:
      put: diego-dusts-logs
      params:
        file: logs/dusts*.log
        acl: public-read

- name: validate-garden-version
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
    - get: garden-runc-release-master
      trigger: true
      params:
        submodules:
        - src/garden
        - src/guardian
    - get: diego-ci
  - task: compare-garden-releases
    file: diego-ci/tasks/compare_garden_releases.build.yml

# Trigger on releases to garden-runc-release. We could use concourse resource for that.
# Bump garden-runc-release
# Bump guardian to match the version used in gardenc-runc-release
# Update the package specs
# Commit the changes
- name: bump-garden
  public: true
  plan:
  - in_parallel:
    - get: diego-release
    - get: diego-ci
    - get: garden-runc-release-master
    - get: garden-runc-release-github-release
      trigger: true
      params:
        include_source_tarball: true
  - task: bump-submodule
    file: diego-ci/tasks/bump_garden_submodules.build.yml
  - put: diego-release
    params:
      repository: bumped-diego-release
      rebase: true
    get_params:
      submodules: none

- name: validate-envoy-version
  public: true
  plan:
  - in_parallel:
    - get: diego-release
      trigger: true
    - get: diego-ci
  - task: compare-envoy-versions
    file: diego-ci/tasks/compare_envoy_versions.build.yml

- name: warp-drive-deploy-cf-deployment
  serial_groups: [warp-drive-cf-deployment]
  plan:
  - get: candidate-lock
    passed: [candidate]
    trigger: true
  - in_parallel:
    - get: deployments-diego
      resource: warp-drive-config
    - get: diego-release
      passed: [candidate]
    - get: diego-ci
    - get: cf-deployment
      passed: [candidate]
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: warp-drive-cats-config
  - task: upload-stemcells
    file: cf-deployment-concourse-tasks/bosh-upload-stemcells/task.yml
    input_mapping: &warp_drive_deployment_input_mappings
      release: diego-release
      ops-files: deployments-diego
      vars-files: deployments-diego
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/warp-drive/deployments/bbl
      OPS_FILES: |
        ../cf-deployment/operations/windows2019-cell.yml
  - task: bosh-deploy-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-deploy/task.yml
    input_mapping: *warp_drive_deployment_input_mappings
    params:
      BBL_STATE_DIR: envs/warp-drive/deployments/bbl
      SYSTEM_DOMAIN: warp-drive.cf-app.com
      VARS_FILES: |
        envs/warp-drive/cf-deployment-vars.yml
        vars/grace-config-vars.yml
      OPS_FILES: |
        ../cf-deployment/operations/use-compiled-releases.yml
        ../cf-deployment/operations/experimental/use-compiled-releases-windows.yml
        ../cf-deployment/operations/scale-database-cluster.yml
        ../cf-deployment/operations/use-external-blobstore.yml
        ../cf-deployment/operations/experimental/enable-direct-io-grootfs.yml
        ../cf-deployment/operations/use-gcs-blobstore-service-account.yml
        ../cf-deployment/operations/windows2019-cell.yml
        ../cf-deployment/operations/use-online-windows2019fs.yml
        operations/set-windows2019-cell-to-2-instances.yml
        operations/scale-up-diego-cells.yml
        ../cf-deployment/operations/experimental/enable-oci-phase-1.yml
        ../cf-deployment/operations/experimental/enable-containerd-for-processes.yml
        ../cf-deployment/operations/experimental/set-cpu-weight.yml
        ../cf-deployment/operations/experimental/set-cpu-weight-windows2019.yml
        ../cf-deployment/operations/experimental/enable-nginx-routing-integrity-windows2019.yml
        ../cf-deployment/operations/enable-tls-on-file-server.yml
        ../cf-deployment/operations/experimental/enable-cpu-throttling.yml
        ../cf-deployment/operations/experimental/set-cpu-weight.yml
        operations/open-files-limit.yml
        operations/set-rep-max-idle-conns.yml
        operations/set-windows2019-cell-max-idle-conns.yml
        operations/disable-health-check-server.yml
        operations/change-loggregator-agent-deployment.yml
        operations/turn-on-debug-mode-on-route-emitter.yml
        operations/app-log-with-rate-limit.yml
  - task: deploy-cf-deployment-with-uptimer
    file: cf-deployment-concourse-tasks/bosh-deploy-with-created-release/task.yml
    input_mapping: *warp_drive_deployment_input_mappings
    params:
      BBL_STATE_DIR: envs/warp-drive/deployments/bbl
      SYSTEM_DOMAIN: warp-drive.cf-app.com
      VARS_FILES: |
        envs/warp-drive/cf-deployment-vars.yml
        vars/grace-config-vars.yml
      DEPLOY_WITH_UPTIME_MEASUREMENTS: true
      FAIL_ON_DOWNTIME: true
      MEASURE_SYSLOG_AVAILABILITY: false
      TCP_DOMAIN: " "
      AVAILABLE_PORT: -1
      APP_PUSHABILITY_THRESHOLD: 1
      HTTP_AVAILABILITY_THRESHOLD: 0
      RECENT_LOGS_THRESHOLD: 100
      STREAMING_LOGS_THRESHOLD: 100
      APP_SYSLOG_AVAILABILITY_THRESHOLD: 0
      USE_SINGLE_APP_INSTANCE: true
      OPS_FILES: &warp_drive_ops_files |
        ../cf-deployment/operations/use-compiled-releases.yml
        ../cf-deployment/operations/experimental/use-compiled-releases-windows.yml
        ../release/operations/add-vizzini-errand.yml
        ../cf-deployment/operations/scale-database-cluster.yml
        ../cf-deployment/operations/use-external-blobstore.yml
        ../cf-deployment/operations/experimental/enable-direct-io-grootfs.yml
        ../cf-deployment/operations/use-gcs-blobstore-service-account.yml
        ../cf-deployment/operations/windows2019-cell.yml
        ../cf-deployment/operations/use-online-windows2019fs.yml
        operations/set-windows2019-cell-to-2-instances.yml
        operations/scale-up-diego-cells.yml
        ../release/operations/enable-vizzini-delcarative-healthcheck-tests.yml
        ../release/operations/enable-vizzini-container-proxy-tests.yml
        ../release/operations/enable-vizzini-container-proxy-tests-mutual-tls.yml
        ../cf-deployment/operations/experimental/enable-oci-phase-1.yml
        ../cf-deployment/operations/experimental/enable-containerd-for-processes.yml
        ../cf-deployment/operations/experimental/set-cpu-weight.yml
        ../cf-deployment/operations/experimental/set-cpu-weight-windows2019.yml
        ../cf-deployment/operations/experimental/enable-nginx-routing-integrity-windows2019.yml
        ../cf-deployment/operations/enable-tls-on-file-server.yml
        ../cf-deployment/operations/experimental/enable-cpu-throttling.yml
        ../cf-deployment/operations/experimental/set-cpu-weight.yml
        operations/open-files-limit.yml
        operations/set-rep-max-idle-conns.yml
        operations/set-windows2019-cell-max-idle-conns.yml
        operations/disable-vizzini-privileged-containers-tests.yml
        operations/stream-vizzini-output.yml
        operations/disable-health-check-server.yml
        operations/change-loggregator-agent-deployment.yml
        operations/turn-on-debug-mode-on-route-emitter.yml
        operations/app-log-with-rate-limit.yml
  - task: enable-docker
    file: cf-deployment-concourse-tasks/set-feature-flags/task.yml
    input_mapping:
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/warp-drive/deployments/bbl
      SYSTEM_DOMAIN: warp-drive.cf-app.com
      ENABLED_FEATURE_FLAGS: diego_docker
  - in_parallel:
    - task: update-integration-configs
      file: cf-deployment-concourse-tasks/update-integration-configs/task.yml
      input_mapping:
        bbl-state: deployments-diego
        integration-configs: warp-drive-cats-config
      params:
        BBL_STATE_DIR: envs/warp-drive/deployments/bbl
        CATS_INTEGRATION_CONFIG_FILE: envs/warp-drive/integration_config.json
        WATS_INTEGRATION_CONFIG_FILE: envs/warp-drive/wats_integration_config.json
        SYSTEM_DOMAIN: warp-drive.cf-app.com
        GIT_COMMIT_EMAIL: "cf-diego@pivotal.io"
        GIT_COMMIT_USERNAME: "Diego CI Bot"
      ensure:
        put: warp-drive-cats-config
        params:
          repository: updated-integration-configs
          rebase: true
    - task: open-asgs-for-credhub
      file: cf-deployment-concourse-tasks/open-asgs-for-bosh-instance-group/task.yml
      input_mapping:
        bbl-state: deployments-diego
      params:
        BBL_STATE_DIR: envs/warp-drive/deployments/bbl
        INSTANCE_GROUP_NAME: credhub
        SYSTEM_DOMAIN: warp-drive.cf-app.com
        SECURITY_GROUP_NAME: credhub-cats-asg
    - task: open-asgs-for-uaa
      file: cf-deployment-concourse-tasks/open-asgs-for-bosh-instance-group/task.yml
      input_mapping:
        bbl-state: deployments-diego
      params:
        BBL_STATE_DIR: envs/warp-drive/deployments/bbl
        INSTANCE_GROUP_NAME: uaa
        SYSTEM_DOMAIN: warp-drive.cf-app.com
        SECURITY_GROUP_NAME: uaa-cats-asg

- name: warp-drive-test-evacuation
  serial_groups: [warp-drive-cf-deployment]
  plan:
  - get: candidate-lock
    passed: [warp-drive-deploy-cf-deployment]
    trigger: true
  - in_parallel:
    - get: deployments-diego
      resource: warp-drive-config
    - get: diego-release
      passed: [warp-drive-deploy-cf-deployment]
    - get: diego-ci
    - get: cf-deployment
      passed: [warp-drive-deploy-cf-deployment]
    - get: cf-deployment-concourse-tasks
    - get: runtime-ci
    - get: warp-drive-cats-config
  - task: restart-diego-cells
    file: diego-ci/tasks/bosh_restart.yml
    input_mapping: *warp_drive_deployment_input_mappings
    params:
      BBL_STATE_DIR: envs/warp-drive/deployments/bbl
      SYSTEM_DOMAIN: warp-drive.cf-app.com
      VARS_FILES: |
        envs/warp-drive/cf-deployment-vars.yml
        vars/grace-config-vars.yml
      DEPLOY_WITH_UPTIME_MEASUREMENTS: true
      FAIL_ON_DOWNTIME: true
      MEASURE_SYSLOG_AVAILABILITY: false
      TCP_DOMAIN: " "
      AVAILABLE_PORT: -1
      APP_PUSHABILITY_THRESHOLD: 1
      HTTP_AVAILABILITY_THRESHOLD: 0
      RECENT_LOGS_THRESHOLD: 100
      STREAMING_LOGS_THRESHOLD: 100
      APP_SYSLOG_AVAILABILITY_THRESHOLD: 0
      USE_SINGLE_APP_INSTANCE: true
      OPS_FILES: *warp_drive_ops_files
      BOSH_RESTART_ARGS: diego-cell

- name: warp-drive-smoke-tests
  serial_groups: [warp-drive-cf-deployment]
  plan:
  - get: candidate-lock
    passed: [warp-drive-deploy-cf-deployment]
    trigger: true
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: deployments-diego
      resource: warp-drive-config
  - task: run-smoke-tests-errand
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/warp-drive/deployments/bbl
      DEPLOYMENT_NAME: cf
      ERRAND_NAME: smoke-tests

- name: warp-drive-vizzini
  serial_groups: [warp-drive-cf-deployment]
  plan:
  - get: candidate-lock
    passed: [warp-drive-smoke-tests]
    trigger: true
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: deployments-diego
      resource: warp-drive-config
  - task: run-vizzini-errand
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/warp-drive/deployments/bbl
      DEPLOYMENT_NAME: cf
      ERRAND_NAME: vizzini
      KEEP_ALIVE: true

- name: warp-drive-cf-acceptance-tests
  serial_groups: [warp-drive-cf-acceptance-tests]
  plan:
  - get: candidate-lock
    passed: [warp-drive-vizzini]
    trigger: true
  - in_parallel:
    - get: diego-release
      params: {submodules: none}
      passed: [warp-drive-deploy-cf-deployment]
    - get: warp-drive-cats-config
    - get: cf-deployment-concourse-tasks
    - get: cf-acceptance-tests
  - task: run-cats
    file: cf-deployment-concourse-tasks/run-cats/task.yml
    input_mapping:
      integration-config: warp-drive-cats-config
    params:
      CONFIG_FILE_PATH: envs/warp-drive/integration_config.json
      SKIP_REGEXP: "Syslog drain"

- name: warp-drive-run-wats
  serial_groups: [warp-drive-cf-deployment]
  plan:
  - get: candidate-lock
    passed: [warp-drive-deploy-cf-deployment,warp-drive-smoke-tests]
    trigger: true
  - in_parallel:
    - get: diego-release
      params: {submodules: none}
      passed: [warp-drive-deploy-cf-deployment]
    - get: warp-drive-cats-config
    - get: cf-deployment-concourse-tasks
    - get: cf-acceptance-tests
  - task: run-cats
    file: cf-deployment-concourse-tasks/run-cats/task.yml
    input_mapping:
      integration-config: warp-drive-cats-config
    params:
      CONFIG_FILE_PATH: envs/warp-drive/wats_integration_config.json
      SKIP_REGEXP: "Syslog drain"
      NODES: 4

- name: warp-drive-vizzini-periodic
  serial_groups: [warp-drive-cf-deployment]
  plan:
  - in_parallel:
    - get: thirty-min
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: deployments-diego
      resource: warp-drive-config
  - task: run-vizzini-errand
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/warp-drive/deployments/bbl
      DEPLOYMENT_NAME: cf
      ERRAND_NAME: vizzini
      KEEP_ALIVE: true

- name: warp-drive-push-canary
  serial: true
  plan:
  - in_parallel:
    - get: diego-ci
    - get: diegocanaryapp
    - get: diegocanarywindowsapp
  - in_parallel:
    - task: push-diego-canary
      file: diego-ci/tasks/push_canary_app.build.yml
      params:
        API: api.warp-drive.cf-app.com
        ORG: canaries
        PASSWORD: ((warp-drive-cf-admin-password))
        SPACE: coal-mine
        USER: admin
        APP_DOMAIN: warp-drive.cf-app.com
        APP_NAME: diego-canary-app
        DEPLOYMENT_NAME: warp-drive
        INSTANCE_COUNT: 20
        CF_STACK: cflinuxfs3
    - task: push-diego-canary-windows
      file: diego-ci/tasks/push_canary_windows_app.build.yml
      params:
        API: api.warp-drive.cf-app.com
        ORG: canaries
        PASSWORD: ((warp-drive-cf-admin-password))
        SPACE: coal-mine
        USER: admin
        APP_NAME: diego-canary-windows-app
        APP_PATH: ViewEnvironment
        INSTANCE_COUNT: 20
        STACK_NAME: windows

- name: warp-drive-bosh-cleanup
  serial: true
  plan:
  - in_parallel:
    - get: diego-ci
    - get: deployments-diego
    - get: daily
      trigger: true
  - task: cleanup
    file: diego-ci/tasks/bosh_cleanup_v2.build.yml
    params:
      DEPLOYMENT_DIR: warp-drive

- name: electron-cannon-bosh-cleanup
  serial_groups: [electron-cannon-bosh]
  serial: true
  plan:
  - in_parallel:
    - get: diego-ci
    - get: deployments-diego
    - get: daily
      trigger: true
  - task: cleanup
    file: diego-ci/tasks/bosh_cleanup_v2.build.yml
    params:
      DEPLOYMENT_DIR: electron-cannon

- name: patch-bump
  serial_groups: [version]
  plan:
  - get: version
    passed: [shipit]
    params:
      bump: patch
      pre: rc
    trigger: true
  - put: version
    params:
      file: version/number

- name: minor-bump
  serial_groups: [version]
  plan:
  - get: version
    params:
      bump: minor
      pre: rc
  - put: version
    params:
      file: version/number

- name: major-bump
  serial_groups: [version]
  plan:
  - get: version
    params:
      bump: major
      pre: rc
  - put: version
    params:
      file: version/number

- name: candidate
  serial: true
  public: true
  plan:
  - put: candidate-lock
    params: {acquire: true}
  - in_parallel:
    - get: diego-release
      passed:
      - check-diego-release
      - check-for-windows-drift
      - check-proto-files
      - units-common
      - units-mysql
      - units-postgres
      - units-windows
      - inigo-mysql
      - inigo-windows
      - inigo-postgres
      - validate-envoy-version
      - upgrade-routability-tests-from-v1.0.0
      - upgrade-acceptance-tests-from-v1.0.0
      - upgrade-routability-tests-from-v1.25.2
      - upgrade-acceptance-tests-from-v1.25.2
      params: {submodules: none}
      trigger: true
    - get: bosh-deployment
    - get: cf-deployment
      trigger: true
    - get: diego-ci

- name: release-candidate-lock
  plan:
  - get: candidate-lock
  - put: candidate-lock
    params: {release: candidate-lock}

- name: electron-cannon-deploy-cf-deployment
  serial_groups: [electron-cannon-cf-deployment]
  plan:
  - get: candidate-lock
    passed: [candidate]
    trigger: true
  - in_parallel:
    - get: deployments-diego
      resource: electron-cannon-config
    - get: diego-release
      passed: [candidate]
    - get: diego-ci
    - get: cf-deployment
      passed: [candidate]
    - get: cf-deployment-concourse-tasks
  - task: upload-stemcells
    file: cf-deployment-concourse-tasks/bosh-upload-stemcells/task.yml
    input_mapping: &electron_cannon_deployment_input_mappings
      release: diego-release
      ops-files: deployments-diego
      vars-files: deployments-diego
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/electron-cannon/deployments/bbl
      OPS_FILES: |
        ../cf-deployment/operations/windows2019-cell.yml
  - task: bosh-deploy-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-deploy-with-created-release/task.yml
    input_mapping: *electron_cannon_deployment_input_mappings
    params:
      BBL_STATE_DIR: envs/electron-cannon/deployments/bbl
      SYSTEM_DOMAIN: electron-cannon.cf-app.com
      VARS_FILES: |
        envs/electron-cannon/cf-deployment-vars.yml
        vars/grace-config-vars.yml
      OPS_FILES: &electron_cannon_ops_files |
        ../cf-deployment/operations/use-compiled-releases.yml
        ../cf-deployment/operations/experimental/use-compiled-releases-windows.yml
        ../release/operations/add-vizzini-errand.yml
        ../release/operations/enable-vizzini-delcarative-healthcheck-tests.yml
        ../release/operations/enable-vizzini-container-proxy-tests.yml
        ../release/operations/enable-vizzini-container-proxy-tests-mutual-tls.yml
        ../cf-deployment/operations/scale-database-cluster.yml
        ../cf-deployment/operations/use-external-blobstore.yml
        ../cf-deployment/operations/use-gcs-blobstore-service-account.yml
        ../cf-deployment/operations/windows2019-cell.yml
        ../cf-deployment/operations/use-online-windows2019fs.yml
        operations/disable-vizzini-privileged-containers-tests.yml
        operations/instance-types.yml
        operations/set-rep-max-idle-conns.yml
        operations/resize-grootfs-store.yml
        operations/stream-vizzini-output.yml
        operations/change-loggregator-agent-deployment.yml
        operations/turn-on-debug-mode-on-route-emitter.yml
        operations/set-windows2019-cell-max-idle-conns.yml
  - task: deploy-cf-deployment-with-uptimer
    file: cf-deployment-concourse-tasks/bosh-deploy-with-created-release/task.yml
    input_mapping: *electron_cannon_deployment_input_mappings
    params:
      BBL_STATE_DIR: envs/electron-cannon/deployments/bbl
      SYSTEM_DOMAIN: electron-cannon.cf-app.com
      VARS_FILES: |
        envs/electron-cannon/cf-deployment-vars.yml
        vars/grace-config-vars.yml
      DEPLOY_WITH_UPTIME_MEASUREMENTS: true
      FAIL_ON_DOWNTIME: true
      CF_ADMIN_PASSWORD: ((electron-cannon-cf-admin-password))
      MEASURE_SYSLOG_AVAILABILITY: false
      TCP_DOMAIN: " "
      AVAILABLE_PORT: -1
      APP_PUSHABILITY_THRESHOLD: 1
      HTTP_AVAILABILITY_THRESHOLD: 0
      RECENT_LOGS_THRESHOLD: 100
      STREAMING_LOGS_THRESHOLD: 100
      APP_SYSLOG_AVAILABILITY_THRESHOLD: 0
      USE_SINGLE_APP_INSTANCE: true
      OPS_FILES: *electron_cannon_ops_files
  - task: enable-docker
    file: diego-ci/tasks/enable_diego_docker_feature_flag.build.yml
    params:
      CF_TARGET: api.electron-cannon.cf-app.com
      CF_USER: admin
      CF_PASSWORD: ((electron-cannon-cf-admin-password))

- name: electron-cannon-test-evacuation
  serial_groups: [electron-cannon-cf-deployment]
  plan:
  - get: candidate-lock
    passed: [electron-cannon-deploy-cf-deployment]
    trigger: true
  - in_parallel:
    - get: deployments-diego
      resource: electron-cannon-config
    - get: diego-release
      passed: [electron-cannon-deploy-cf-deployment]
    - get: diego-ci
    - get: cf-deployment
      passed: [electron-cannon-deploy-cf-deployment]
    - get: cf-deployment-concourse-tasks
  - task: restart-diego-cells
    file: diego-ci/tasks/bosh_restart.yml
    input_mapping: *electron_cannon_deployment_input_mappings
    params:
      BBL_STATE_DIR: envs/electron-cannon/deployments/bbl
      SYSTEM_DOMAIN: electron-cannon.cf-app.com
      VARS_FILES: |
        envs/electron-cannon/cf-deployment-vars.yml
        vars/grace-config-vars.yml
      DEPLOY_WITH_UPTIME_MEASUREMENTS: true
      FAIL_ON_DOWNTIME: true
      CF_ADMIN_PASSWORD: ((electron-cannon-cf-admin-password))
      MEASURE_SYSLOG_AVAILABILITY: false
      TCP_DOMAIN: " "
      AVAILABLE_PORT: -1
      APP_PUSHABILITY_THRESHOLD: 1
      HTTP_AVAILABILITY_THRESHOLD: 0
      RECENT_LOGS_THRESHOLD: 100
      STREAMING_LOGS_THRESHOLD: 100
      APP_SYSLOG_AVAILABILITY_THRESHOLD: 0
      USE_SINGLE_APP_INSTANCE: true
      OPS_FILES: *electron_cannon_ops_files
      BOSH_RESTART_ARGS: diego-cell

- name: electron-cannon-smoke-tests
  serial_groups: [electron-cannon-cf-deployment]
  plan:
  - get: candidate-lock
    passed: [electron-cannon-deploy-cf-deployment]
    trigger: true
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: deployments-diego
      resource: electron-cannon-config
  - task: run-smoke-tests-errand
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/electron-cannon/deployments/bbl
      DEPLOYMENT_NAME: cf
      ERRAND_NAME: smoke-tests

- name: electron-cannon-vizzini
  serial_groups: [electron-cannon-cf-deployment]
  plan:
  - get: candidate-lock
    passed: [electron-cannon-smoke-tests]
    trigger: true
  - in_parallel:
    - get: cf-deployment-concourse-tasks
    - get: deployments-diego
      resource: electron-cannon-config
    - get: cf-deployment
      passed: [electron-cannon-deploy-cf-deployment]
  - task: run-vizzini-errand
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/electron-cannon/deployments/bbl
      DEPLOYMENT_NAME: cf
      ERRAND_NAME: vizzini
      KEEP_ALIVE: true

- name: electron-cannon-cf-acceptance-tests
  serial_groups: [electron-cannon-cf-acceptance-tests]
  plan:
  - get: candidate-lock
    passed: [electron-cannon-vizzini]
    trigger: true
  - in_parallel:
    - get: diego-release
      params: {submodules: none}
      passed: [electron-cannon-deploy-cf-deployment]
    - get: electron-cannon-cats-config
    - get: cf-deployment-concourse-tasks
    - get: cf-acceptance-tests
    - get: cf-deployment
      passed: [electron-cannon-deploy-cf-deployment]
  - task: run-cats
    file: cf-deployment-concourse-tasks/run-cats/task.yml
    input_mapping:
      integration-config: electron-cannon-cats-config
    params:
      CONFIG_FILE_PATH: envs/electron-cannon/integration_config.json

- name: electron-cannon-run-wats
  plan:
  - get: candidate-lock
    passed: [electron-cannon-deploy-cf-deployment,electron-cannon-smoke-tests]
    trigger: true
  - in_parallel:
    - get: diego-release
      params: {submodules: none}
      passed: [electron-cannon-deploy-cf-deployment]
    - get: electron-cannon-cats-config
    - get: cf-deployment-concourse-tasks
    - get: cf-acceptance-tests
    - get: cf-deployment
      passed: [electron-cannon-deploy-cf-deployment]
  - task: run-cats
    file: cf-deployment-concourse-tasks/run-cats/task.yml
    input_mapping:
      integration-config: electron-cannon-cats-config
    params:
      CONFIG_FILE_PATH: envs/electron-cannon/wats_integration_config.json
      SKIP_REGEXP: "Syslog drain"
      NODES: 4

- name: electron-cannon-vizzini-periodic
  serial_groups: [electron-cannon-cf-deployment]
  plan:
  - in_parallel:
    - get: thirty-min
      trigger: true
    - get: cf-deployment-concourse-tasks
    - get: deployments-diego
      resource: electron-cannon-config
  - task: run-vizzini-errand
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/electron-cannon/deployments/bbl
      DEPLOYMENT_NAME: cf
      ERRAND_NAME: vizzini
      KEEP_ALIVE: true

- name: electron-cannon-push-canary
  serial_groups: [electron-cannon-push-canary]
  serial: true
  plan:
  - in_parallel:
    - get: diego-ci
    - get: diegocanaryapp
    - get: diegocanarywindowsapp
  - in_parallel:
    - task: push-diego-canary
      file: diego-ci/tasks/push_canary_app.build.yml
      params:
        API: api.electron-cannon.cf-app.com
        ORG: canaries
        PASSWORD: ((electron-cannon-cf-admin-password))
        SPACE: coal-mine
        USER: admin
        APP_DOMAIN: electron-cannon.cf-app.com
        APP_NAME: diego-canary-app
        DEPLOYMENT_NAME: electron-cannon
        INSTANCE_COUNT: 20
        CF_STACK: cflinuxfs3
    - task: push-diego-canary-windows
      file: diego-ci/tasks/push_canary_windows_app.build.yml
      params:
        API: api.electron-cannon.cf-app.com
        ORG: canaries
        PASSWORD: ((electron-cannon-cf-admin-password))
        SPACE: coal-mine
        USER: admin
        APP_NAME: diego-canary-windows-app
        APP_PATH: ViewEnvironment
        INSTANCE_COUNT: 1
        STACK_NAME: windows

- name: export-diego-release
  serial_groups: [electron-cannon-cf-deployment]
  plan:
    - get: candidate-lock
      passed: [electron-cannon-deploy-cf-deployment]
      trigger: true
    - in_parallel:
      - get: deployments-diego
      - get: diego-ci
    - task: export-release
      file: diego-ci/tasks/bosh_export_release.build.yml
      params:
        DEPLOYMENT_DIR: envs/electron-cannon
        RELEASE_NAME: diego

- name: deliver
  plan:
  - get: candidate-lock
    passed:
    - candidate
    - electron-cannon-cf-acceptance-tests
    - electron-cannon-vizzini
    - electron-cannon-test-evacuation
    - electron-cannon-run-wats
    - warp-drive-vizzini
    - warp-drive-test-evacuation
    - warp-drive-cf-acceptance-tests
    - warp-drive-run-wats
    - export-diego-release
    trigger: true
  - in_parallel:
    - get: diego-release
      passed: [candidate]
      params: {submodules: none}
    - get: cf-deployment
      passed:
      - electron-cannon-vizzini
      - electron-cannon-cf-acceptance-tests
      - electron-cannon-run-wats
  - put: tracker
    params: {repos: [diego-release]}
  - put: diego-release-release-candidate
    params:
      repository: diego-release/
  - put: candidate-lock
    params: {release: candidate-lock}

- name: shipit
  serial_groups: [version]
  plan:
  - in_parallel:
    - get: diego-ci
    - get: cf-deployment
      passed: [deliver]
    - get: diego-release
      passed: [deliver]
    - get: diego-release-master
      params: {submodules: none}
    - get: version
      params: {bump: final}
  - task: create-final-release
    file: diego-ci/tasks/create_final_release.build.yml
    params:
      access_key_id: ((aws-diego-final-release-access-key-id))
      secret_access_key: ((aws-diego-final-release-secret-access-key))
  - put: diego-final-releases
    params:
      file: final-release/diego-*.tgz
  - put: diego-release-master
    params:
      repository: final-release/diego-release
      tag: version/number
      tag_prefix: v
  - put: version
    params: {file: version/number}

- name: github-release
  plan:
  - in_parallel:
    - get: diego-ci
    - get: cf-deployment
      passed: [shipit]
      trigger: true
    - get: diego-final-releases
      passed: [shipit]
      trigger: true
    - get: diego-release-master
      passed: [shipit]
      params: {submodules: none}
      trigger: true
  - task: generate-release
    file: diego-ci/tasks/generate_github_release.build.yml
  - put: github-release
    params:
      commitish: generated-release/commitish
      name: generated-release/name
      tag: generated-release/version
      body: generated-release/body

- name: merge-master-into-develop
  plan:
    - in_parallel:
      - get: diego-ci
      - get: diego-release-master
        trigger: true
        passed: [shipit]
        params:
          submodules: none
      - get: diego-release
        params:
          submodules: none
    - task: merge-master-into-develop
      file: diego-ci/tasks/merge-master-into-develop.build.yml
    - put: diego-release-mergeback
      params:
        repository: merged-master/diego-release

- name: time-rotor-gcp-bosh-cleanup
  serial_groups: [time-rotor-gcp-bosh]
  serial: true
  plan:
  - in_parallel:
    - get: diego-ci
    - get: deployments-diego
    - get: daily
      trigger: true
  - task: cleanup
    file: diego-ci/tasks/bosh_cleanup_v2.build.yml
    params:
      DEPLOYMENT_DIR: time-rotor-gcp
  - task: udpate-rc
    file: diego-ci/tasks/bosh_urc.build.yml
    params:
      DEPLOYMENT_DIR: envs/time-rotor-gcp
      NAME: dns

- name: time-rotor-gcp-benchmark-bbs-tests
  serial_groups: [time-rotor-gcp-benchmark]
  plan:
  - in_parallel:
    - get: deployments-diego
      resource: time-rotor-gcp-config
    - get: diego-release
      passed: [deliver]
      trigger: true
    - get: tweleve-hours
      trigger: true
    - get: diego-ci
    - get: cf-deployment
      passed: [deliver]
    - get: cf-deployment-concourse-tasks
  - task: upload-stemcells
    file: cf-deployment-concourse-tasks/bosh-upload-stemcells/task.yml
    input_mapping: &time_rotor_deployment_input_mappings
      release: diego-release
      ops-files: deployments-diego
      vars-files: deployments-diego
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/time-rotor-gcp/deployments/bbl
  - task: deploy-cf-deployment
    file: cf-deployment-concourse-tasks/bosh-deploy-with-created-release/task.yml
    input_mapping: *time_rotor_deployment_input_mappings
    params:
      SYSTEM_DOMAIN: time-rotor-gcp.cf-app.com
      BBL_STATE_DIR: envs/time-rotor-gcp/deployments/bbl
      VARS_FILES: |
        envs/time-rotor-gcp/vars/cf-deployment-vars.yml
        envs/time-rotor-gcp/vars/deployment-network-name-vars.yml
      DEPLOY_WITH_UPTIME_MEASUREMENTS: false
      DEPLOYMENT: time_rotor_gcp
      OPS_FILES: |
        ../cf-deployment/operations/use-compiled-releases.yml
        ../cf-deployment/operations/rename-network-and-deployment.yml
        ../release/operations/benchmarks/mysql.yml
        operations/bbs-benchmark.yml
        operations/overrides.yml
        operations/remove-reverse-log-proxy-gateway.yml
        operations/disable-pxc-tls.yml
        operations/disable-credhub.yml
  - task: run
    file: cf-deployment-concourse-tasks/run-errand/task.yml
    input_mapping:
      bbl-state: deployments-diego
    params:
      BBL_STATE_DIR: envs/time-rotor-gcp/deployments/bbl
      DEPLOYMENT_NAME: time_rotor_gcp
      ERRAND_NAME: diego-benchmarks
      KEEP_ALIVE: true
    on_success:
      in_parallel:
      - task: delete-deployment
        file: diego-ci/tasks/bosh_delete_deployments.build.yml
        params:
          DEPLOYMENTS: time_rotor_gcp
          DEPLOYMENT_DIR: envs/time-rotor-gcp

- name: oslo-scan-status
  plan:
  - get: oslo-scan-status
    trigger: true
  - task: check-status-file
    config:
      container_limits: {}
      platform: linux
      image_resource:
        type: docker-image
        source: { repository: ubuntu }
      inputs:
      - name: oslo-scan-status
      run:
        path: sh
        args:
        - -c
        - |
          status_file=oslo-scan-status/diego-release/status.json
          cat "$status_file"
          num_failures="$(grep -c '"status": "failed"' $status_file)"
          echo ""
          if [ "$num_failures" -eq 0 ]; then
            echo "No failures found"
            exit 0
          else
            echo "$num_failures failures found! Please check your norsk-viewers pipelines specified in the status.json and resolve the errors. Contact the OSL team if you need help."
            exit 1
          fi


resource_types:
- name: bosh2-deployment
  type: docker-image
  source:
    repository: cloudfoundry/bosh-deployment-resource

resources:
- name: thirty-min
  type: time
  source:
    interval: 30m

- name: tweleve-hours
  type: time
  source:
    interval: 12h

- name: daily
  type: time
  source:
    interval: 24h

- name: nightly
  type: time
  source:
    start: 12:00 AM
    stop: 1:00 AM
    location: America/Los_Angeles

- name: every-30-days
  type: time
  source:
    interval: 720h

- name: electron-cannon-config
  type: git
  source:
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: ((cf-diego-private-key))

- name: time-rotor-gcp-config
  type: git
  source:
    paths:
    - envs/time-rotor-gcp
    - operations
    - vars
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: ((cf-diego-private-key))

- name: warp-drive-config
  type: git
  source:
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: ((cf-diego-private-key))

- name: warp-drive-cats-config
  type: git
  source:
    branch: master
    paths:
    - envs/warp-drive/integration_config.json
    - envs/warp-drive/wats_integration_config.json
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: ((cf-diego-private-key))

- name: electron-cannon-cats-config
  type: git
  source:
    paths:
    - envs/electron-cannon/integration_config.json
    - envs/electron-cannon/wats_integration_config.json
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: ((cf-diego-private-key))

- name: diego-ci
  type: git
  source:
    uri: git@github.com:cloudfoundry/diego-ci
    private_key: ((cf-diego-private-key))

- name: deployments-diego
  type: git
  source:
    branch: master
    uri: git@github.com:cloudfoundry/deployments-diego.git
    private_key: ((cf-diego-private-key))

- name: bosh-deployment
  type: git
  source:
    uri: https://github.com/cloudfoundry/bosh-deployment.git

- name: bosh-bootloader
  type: git
  source:
    branch: main
    uri: git@github.com:cloudfoundry/bosh-bootloader.git
    private_key: ((cf-diego-private-key))

- name: cf-deployment
  type: git
  source:
    branch: main
    uri: git@github.com:cloudfoundry/cf-deployment.git
    private_key: ((cf-diego-private-key))

- name: cf-acceptance-tests
  type: git
  source:
    branch: release-candidate
    uri: https://github.com/cloudfoundry/cf-acceptance-tests.git

- name: routing-release
  type: git
  source:
    branch: release
    uri: https://github.com/cloudfoundry-incubator/routing-release.git

- name: diego-release
  type: git
  source:
    branch: develop
    fetch: ["master"]
    ignore_paths:
      - dev_releases
      - git-hooks
    uri: git@github.com:cloudfoundry/diego-release.git
    private_key: ((cf-diego-private-key))

- name: version
  type: semver
  source:
    access_key_id: ((aws-diego-pipeline-access-key-id))
    secret_access_key: ((aws-diego-pipeline-secret-access-key))
    bucket: diego-release-versions
    initial_version: 0.1000.0
    key: current-version
    region_name: us-east-1

- name: diego-final-releases
  type: s3
  source:
    bucket: diego-final-releases
    regexp: diego-(.*).tgz
    access_key_id: ((aws-diego-final-release-access-key-id))
    secret_access_key: ((aws-diego-final-release-secret-access-key))

- name: diego-dusts-logs
  type: s3
  source:
    bucket: diego-trace-logs
    regexp: ketchup-smoke-tests/dusts-component-logs\.(0\.0\.0)\.[\d\.\-]+.log
    access_key_id: ((aws-diego-pipeline-access-key-id))
    secret_access_key: ((aws-diego-pipeline-secret-access-key))

- name: diego-release-release-candidate
  type: git
  source:
    uri: git@github.com:cloudfoundry/diego-release.git
    branch: release-candidate
    private_key: ((cf-diego-private-key))

- name: diego-release-golang-bump
  type: git
  source:
    uri: git@github.com:cloudfoundry/diego-release.git
    branch: bump-golang
    private_key: ((cf-diego-private-key))

- name: envoyproxy-image
  type: docker-image
  source:
    repository: envoyproxy/envoy
    tag: v1.16-latest

- name: diego-release-envoy-bump
  type: git
  source:
    uri: git@github.com:cloudfoundry/diego-release.git
    branch: bump-envoy
    private_key: ((cf-diego-private-key))

- name: diego-release-master
  type: git
  source:
    uri: git@github.com:cloudfoundry/diego-release.git
    branch: master
    private_key: ((cf-diego-private-key))

- name: diego-release-mergeback
  type: git
  source:
    uri: git@github.com:cloudfoundry/diego-release.git
    branch: develop
    private_key: ((cf-diego-private-key))

- name: candidate-lock
  type: pool
  source:
    uri: git@github.com:cloudfoundry/diego-ci-pools.git
    branch: master
    pool: candidate-lock
    private_key: ((cf-diego-private-key))

- name: tracker
  type: tracker
  source:
    tracker_url: https://www.pivotaltracker.com
    project_id: "1003146"
    token: ((tracker-token))

- name: routing-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry-incubator/cf-routing-release

- name: garden-runc-release-tarball
  type: bosh-io-release
  source:
    repository: cloudfoundry/garden-runc-release

- name: garden-runc-release-master
  type: git
  source:
    uri: https://github.com/cloudfoundry/garden-runc-release
    branch: master

- name: garden-runc-release-github-release
  type: github-release
  source:
    user: cloudfoundry
    repository: garden-runc-release

- name: winc-release
  type: git
  source:
    uri: https://github.com/cloudfoundry/winc-release
    branch: master

- name: envoy-nginx-release
  type: git
  source:
    uri: https://github.com/cloudfoundry-incubator/envoy-nginx-release
    branch: master

- name: github-release
  type: github-release
  source:
    user: cloudfoundry
    repository: diego-release
    drafts: true
    access_token: ((pm-personal-access-token))

- name: diego-release-v1.0.0
  type: git
  source:
    uri: https://github.com/cloudfoundry/diego-release.git
    branch: v1.0.0-patch-10

- name: diego-release-v1.25.2
  type: git
  source:
    uri: https://github.com/cloudfoundry/diego-release.git
    branch: v1.25.2-patch-9

- name: diegocanaryapp
  type: git
  source:
    uri: https://github.com/cloudfoundry/diegocanaryapp.git

- name: diegocanarywindowsapp
  type: git
  source:
    uri: https://github.com/cloudfoundry-incubator/NET-sample-app

- name: cf-deployment-concourse-tasks
  type: git
  source:
    branch: main
    uri: https://github.com/cloudfoundry/cf-deployment-concourse-tasks
    tag_filter: v*

# There's a task to open up ASGs in here that we'd like to use. RelInt is planning to eventually add that task to cf-d-c-t
- name: runtime-ci
  type: git
  source:
    branch: main
    uri: https://github.com/cloudfoundry/runtime-ci

- name: golang-release
  type: git
  source:
    branch: master
    uri: https://github.com/bosh-packages/golang-release
    tag_filter: v*

- name: oslo-scan-status
  type: git
  source:
    paths:
    - diego-release/*
    private_key: ((norsk-deploy-key))
    uri: git@github.com:pivotal/oslo-scan-status.git
